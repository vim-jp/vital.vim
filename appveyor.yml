version: '{build}'
clone_depth: 10
environment:
  global:
    VIMPROC_VERSION: ver.9.2
    VIM_THEMIS_VERSION: v1.5.2.1
  matrix:
    - VIM_URL: http://vim-jp.org/redirects/koron/vim-kaoriya/vim74/oldest/win64/
    - VIM_URL: http://vim-jp.org/redirects/koron/vim-kaoriya/vim80/oldest/win64/
    - VIM_URL: http://vim-jp.org/redirects/koron/vim-kaoriya/latest/win64/
    # To test with latest official Vim binary, uncomment below line.
    #- VIM_URL: http://vim-jp.org/redirects/vim/vim-win32-installer/latest/x64/
install:
  - ps: |
      $zip = $Env:APPVEYOR_BUILD_FOLDER + '\vim.zip'
      $vim = $Env:APPVEYOR_BUILD_FOLDER + '\vim\'
      $redirect = Invoke-WebRequest -URI $Env:VIM_URL
      (New-Object Net.WebClient).DownloadFile($redirect.Links[0].href, $zip)
      [Reflection.Assembly]::LoadWithPartialName('System.IO.Compression.FileSystem') > $null
      [System.IO.Compression.ZipFile]::ExtractToDirectory($zip, $vim)
      $Env:THEMIS_VIM = $vim + (Get-ChildItem $vim).Name + '\vim.exe'
  - 'mkdir %TEMP%\vimproc && pushd %TEMP%\vimproc && curl -fsSL --retry 3 https://github.com/Shougo/vimproc.vim/archive/%VIMPROC_VERSION%.tar.gz | tar -xz --strip-components 1 && popd'
  - 'appveyor DownloadFile https://github.com/Shougo/vimproc.vim/releases/download/%VIMPROC_VERSION%/vimproc_win64.dll -FileName %TEMP%\vimproc\lib\vimproc_win64.dll'

  - 'mkdir %TEMP%\vim-themis && pushd %TEMP%\vim-themis && curl -fsSL --retry 3 https://github.com/thinca/vim-themis/archive/%VIM_THEMIS_VERSION%.tar.gz | tar -xz --strip-components 1 && popd'
  - 'reg copy HKLM\SOFTWARE\Python\PythonCore\2.7 HKLM\SOFTWARE\Python\PythonCore\2.7-32 /s /reg:32'
  - 'reg copy HKLM\SOFTWARE\Python\PythonCore\2.7 HKLM\SOFTWARE\Python\PythonCore\2.7-32 /s /reg:64'
build: off
test_script:
  - '%THEMIS_VIM% --version'
  - '%TEMP%\vim-themis\bin\themis.bat --runtimepath %TEMP%\vimproc --exclude ConcurrentProcess --reporter dot'
deploy: off
notifications:
  - provider: Webhook
    url: http://appveyor.herokuapp.com/vim
    headers:
      User-Agent: appveyor-lingrbot 1.0
      Authorization:
        secure: cjzTMN7bP3fkRnz6S0ZRjc0Q3nPPvdJ7AXrizCQBKK0=
    on_build_success: false
    on_build_failure: true
